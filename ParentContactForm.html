<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نموذج التواصل مع ولي أمر الطالبة</title>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>

<style>
@font-face {
  font-family: 'HelveticaNeueW23';
  src: url('fonts/HelveticaNeueW23-Regular.ttf') format('truetype');
}
body, input, select, label, button {
  font-family: 'HelveticaNeueW23', Arial, sans-serif;
  margin:0; padding:0;
}
body { background-color: #f9f9f9; }
header {
  background:#15445A;
  color:white;
  text-align:center;
  padding:15px;
}
header h1 { margin:0; font-size:18px; }
label {
  display:block;
  margin:5px 0 2px;
  font-weight:bold;
  font-size:12px;
  text-align:center;
}
input, textarea, select {
  width:100%;
  padding:6px;
  border:1px solid #c2c1c2;
  border-radius:4px;
  margin-bottom:5px;
  box-sizing:border-box;
  font-size:12px;
  text-align:center;
  background-color: white;
}
button {
  background:#0c8380;
  color:white;
  border:none;
  padding:12px 0;
  margin-top:10px;
  cursor:pointer;
  border-radius:6px;
  font-size:16px;
  font-weight:bold;
  width:100%;
}
.red-clear-btn {
  background:red !important;
  margin-top:5px;
  font-weight:bold;
}
#studentChart {
  width:100%;
  height:320px;
  margin-top:10px;
  transform:scale(0.5);
  transform-origin:center;
}
.rating-display {
  display:block;
  text-align:center;
  margin-top:5px;
  font-weight:bold;
  color:#d73027;
  font-size:16px;
  background-color:#f9eaea;
  border-radius:6px;
  padding:5px;
}
#images-preview img {
  width:70px;
  height:70px;
  object-fit:cover;
  border:1px solid #ccc;
  border-radius:4px;
}
@media print {
  button, input[type='file'], #images-counter { display:none; }
}
</style>
</head>
<body>

<header><h1>نموذج التواصل مع ولي أمر الطالبة</h1></header>

<div style="max-width:800px; margin:auto; padding:10px;" id="formContainer">

  <div style="display:flex; gap:10px; justify-content:center; margin-top:5px;">
    <div><label>اسم المعلمة</label><input type="text" id="teacherName"></div>
    <div><label>المادة</label><input type="text" id="subject"></div>
    <div><label>الفصل الدراسي</label><input type="text" id="semester"></div>
  </div>

  <div style="display:flex; gap:10px; justify-content:center;">
    <div><label>اسم الطالبة</label><input type="text" id="studentName"></div>
    <div><label>الصف</label><input type="text" id="studentClass"></div>
    <div><label>اليوم</label><input type="text" id="day"></div>
    <div><label>التاريخ</label><input type="text" id="date1" placeholder="اختر التاريخ" style="flex:1;" readonly /></div>
  </div>

  <div style="display:flex; gap:10px; justify-content:center;">
    <div>
      <label>مستوى التعليم</label>
      <select id="selEdu" onchange="updateChartAndInputs()">
        <option value="0">0%</option><option value="10">10%</option><option value="20">20%</option>
        <option value="30">30%</option><option value="40">40%</option><option value="50">50%</option>
        <option value="60">60%</option><option value="70">70%</option>
        <option value="80">80%</option><option value="90">90%</option>
        <option value="100">100%</option>
      </select>
      <div id="displayEdu" class="rating-display"></div>
    </div>
    <div>
      <label>مستوى السلوك</label>
      <select id="selBeh" onchange="updateChartAndInputs()">
        <option value="0">0%</option><option value="10">10%</option><option value="20">20%</option>
        <option value="30">30%</option><option value="40">40%</option><option value="50">50%</option>
        <option value="60">60%</option><option value="70">70%</option>
        <option value="80">80%</option><option value="90">90%</option>
        <option value="100">100%</option>
      </select>
      <div id="displayBeh" class="rating-display"></div>
    </div>
    <div>
      <label>مستوى المواظبة</label>
      <select id="selAtt" onchange="updateChartAndInputs()">
        <option value="0">0%</option><option value="10">10%</option><option value="20">20%</option>
        <option value="30">30%</option><option value="40">40%</option><option value="50">50%</option>
        <option value="60">60%</option><option value="70">70%</option>
        <option value="80">80%</option><option value="90">90%</option>
        <option value="100">100%</option>
      </select>
      <div id="displayAtt" class="rating-display"></div>
    </div>
  </div>

  <label>ملاحظات المعلمة</label>
  <input type="text" id="teacherNotes">
  <input type="text" id="teacherNotes2">

  <h5 style="text-align:center; margin-top:12px;">الرسم البياني لمستوى الطالبة</h5>
  <div id="studentChart"></div>

  <input type="file" multiple accept="image/*" onchange="storeImages(event)">
  <div id="images-counter" style="font-size:12px; color:#15445a; font-weight:bold;">عدد الصور المرفوعة: 0 / 4</div>
  <div id="images-preview" style="display:flex; gap:5px; flex-wrap:wrap; margin-top:5px; margin-bottom:10px;"></div>

  <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
    <div><label>الموجهة الطلابية</label><input type="text" id="supervisor"></div>
    <div><label>مديرة المدرسة</label><input type="text" id="schoolManager"></div>
  </div>

  <button onclick="printPDF()">طباعة PDF</button>
  <button class="red-clear-btn" onclick="clearForm()">حذف البيانات</button>

</div>

<script>
let uploadedImages = [];

document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById('date1');
  if (input) {
    flatpickr(input, {
      locale: 'ar',
      disableMobile: true,
      altInput: true,
      altFormat: 'd-MM-yyyy هـ',
      dateFormat: 'Y-m-d',
      onChange: function(selectedDates, dateStr, instance) {
        if (selectedDates.length > 0) {
          const miladi = selectedDates[0];
          miladi.setDate(miladi.getDate() - 1);
          const hijri = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).format(miladi);
          instance.altInput.value = hijri;
        }
      }
    });
  }
  updateChartAndInputs();
  updateCounter();
});

function storeImages(event){
  const files = event.target.files;
  if(uploadedImages.length + files.length > 4){
    alert('مسموح برفع 4 صور فقط.');
    event.target.value='';
    return;
  }
  for(let i=0;i<files.length;i++){
    const reader = new FileReader();
    reader.onload = e=>{
      uploadedImages.push(e.target.result);
      updateCounter();
      renderPreview();
    };
    reader.readAsDataURL(files[i]);
  }
}

function updateCounter(){
  const count = uploadedImages.length;
  const counter = document.getElementById("images-counter");
  counter.textContent = 'عدد الصور المرفوعة: ' + count + ' / 4';
  counter.style.color = count>=4 ? 'red' : '#15445a';
}

function renderPreview(){
  const preview = document.getElementById("images-preview");
  preview.innerHTML = '';
  uploadedImages.forEach((src,index)=>{
    const container = document.createElement('div');
    container.style.position='relative';
    const img=document.createElement('img');
    img.src=src;
    const btn=document.createElement('button');
    btn.textContent='x';
    btn.style.position='absolute';
    btn.style.top='2px';
    btn.style.left='50%';
    btn.style.transform='translateX(-50%)';
    btn.style.width='18px';
    btn.style.height='18px';
    btn.style.fontSize='10px';
    btn.style.background='red';
    btn.style.color='white';
    btn.style.border='2px solid white';
    btn.style.borderRadius='50%';
    btn.style.cursor='pointer';
    btn.onclick=()=>{ uploadedImages.splice(index,1); updateCounter(); renderPreview(); };
    container.appendChild(img);
    container.appendChild(btn);
    preview.appendChild(container);
  });
}

function ratingText(val){
  if(val>=90) return 'ممتاز';
  if(val>=80) return 'جيد جدا';
  if(val>=70) return 'جيد';
  if(val>=60) return 'مقبول';
  return 'ضعيف';
}

function updateChartAndInputs(){
  const vEdu = Number(document.getElementById('selEdu').value);
  const vBeh = Number(document.getElementById('selBeh').value);
  const vAtt = Number(document.getElementById('selAtt').value);

  document.getElementById('displayEdu').textContent = ratingText(vEdu) + ' ' + vEdu + '%';
  document.getElementById('displayBeh').textContent = ratingText(vBeh) + ' ' + vBeh + '%';
  document.getElementById('displayAtt').textContent = ratingText(vAtt) + ' ' + vAtt + '%';

  const values = [vEdu,vBeh,vAtt];
  const labels = ['مستوى التعليم','مستوى السلوك','مستوى المواظبة'];
  const texts = [
    ratingText(vEdu) + ' %' + vEdu,
    ratingText(vBeh) + ' %' + vBeh,
    ratingText(vAtt) + ' %' + vAtt
  ];

  const trace = {
    x: labels,
    y: values,
    type:'bar',
    text:texts,
    textposition:'auto',
    hoverinfo:'none',
    marker:{color:['#56CC8A','#FFBD80','#58A5ED']},
    textfont:{family:'HelveticaNeueW23, Arial, sans-serif', size:12, color:'black'}
  };
  const layout = {
    margin:{l:40,r:20,b:40,t:40},
    yaxis:{title:'النسبة %', range:[0,100]}
  };
  Plotly.newPlot('studentChart',[trace],layout,{displayModeBar:false,responsive:true, staticPlot:true});
}

function printPDF(){
  const wrapper = document.createElement('div');
  wrapper.style.width='210mm';
  wrapper.style.minHeight='296.5mm';
  wrapper.style.padding='30mm 10mm 10mm 10mm';
  wrapper.style.boxSizing='border-box';
  wrapper.style.backgroundImage='url("images/background.png")';
  wrapper.style.backgroundSize='cover';
  wrapper.style.backgroundRepeat='no-repeat';
  wrapper.style.backgroundPosition='center';

  const content = document.getElementById('formContainer').cloneNode(true);
  content.querySelectorAll('button,input[type="file"],#images-counter,#images-preview').forEach(el=>el.remove());

  Plotly.toImage(document.getElementById('studentChart'), {
    format:'png',
    width:450,
    height:200
  }).then(function(dataUrl){
    const imgChart = document.createElement('img');
    imgChart.src=dataUrl;
    imgChart.style.width='70%';
    imgChart.style.display='block';
    imgChart.style.margin='auto';

    const chartDiv = content.querySelector('#studentChart');
    if(chartDiv) chartDiv.replaceWith(imgChart);

    if(uploadedImages.length>0){
      const imagesWrapper = document.createElement('div');
      imagesWrapper.style.display='flex';
      imagesWrapper.style.justifyContent='center';
      imagesWrapper.style.flexWrap='wrap';
      imagesWrapper.style.gap='5px';
      imagesWrapper.style.margin='5px 0 10px 0';
      uploadedImages.forEach(src=>{
        const img=document.createElement('img');
        img.src=src;
        img.style.width='160px';
        img.style.height='140px';
        img.style.objectFit='cover';
        imagesWrapper.appendChild(img);
      });
      imgChart.parentNode.insertBefore(imagesWrapper,imgChart.nextSibling);
    }

    wrapper.appendChild(content);

    html2pdf().set({
      margin:0,
      filename:'student_form.pdf',
      image:{type:'jpeg', quality:0.95},
      html2canvas:{scale:3, useCORS:true, backgroundColor:null, scrollY:0},
      jsPDF:{unit:'mm', format:'a4', orientation:'portrait'}
    }).from(wrapper).save();
  });
}

function clearForm(){
  if(!confirm('هل أنت متأكدة من حذف جميع البيانات؟')) return;
  const container = document.getElementById('formContainer');
  container.querySelectorAll('input[type="text"], textarea').forEach(el=>el.value='');
  container.querySelectorAll('select').forEach(el=>el.selectedIndex=0);
  uploadedImages = [];
  updateCounter();
  renderPreview();
  updateChartAndInputs();
}
</script>

</body>
</html>
