<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>تقرير حصة الانتظار</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
body {
  margin: 0;
  padding: 0;
  font-family: 'HelveticaNeueW23', Arial, sans-serif;
  background: #ffffff;
}
@font-face {
  font-family: 'HelveticaNeueW23';
  src: url('fonts/HelveticaNeueW23-Regular.ttf') format('truetype');
}

header {
  background: #0c8380;
  color: white;
  text-align: center;
  padding: 10px;
}
header h3 {
  margin: 3px 0;
  font-size: 16px;
}

/* تكبير حجم كلمة حصة الانتظار */
h3 label {
  font-weight: bold;
  font-size: 18px;
  text-align: center;
  display: block;
  margin-bottom: 10px;
}

label {
  display: block;
  margin: 5px 0 2px;
  font-weight: bold;
  font-size: 12px;
  text-align: center;
}

input,
textarea {
  width: 100%;
  padding: 4px;
  border: 1px solid #c2c1c2;
  border-radius: 4px;
  margin-bottom: 5px;
  box-sizing: border-box;
  font-size: 12px;
  text-align: center;
  background: transparent;
  font-family: 'HelveticaNeueW23', Arial, sans-serif;
}

textarea {
  min-height: 40px;
}

button {
  border: none;
  padding: 8px 10px;
  margin: 5px 0;
  cursor: pointer;
  border-radius: 6px;
  width: 100%;
  font-size: 14px;
  font-weight: bold;
  font-family: 'HelveticaNeueW23', Arial, sans-serif;
  text-align: center;
}

button.printBtn {
  background: #0c8380;
  color: white;
}
button.deleteBtn {
  background: red;
  color: white;
}

footer {
  text-align: center;
  padding: 10px;
  color: black;
  font-weight: bold;
  font-size: 12px;
}

@media print {
  body {
    background: none !important;
  }

  input,
  textarea,
  label {
    background: transparent !important;
    color: black;
    border-color: #c2c1c2;
    margin-bottom: 20px !important;
  }

  #directorField {
    display: none;
  }
}
</style>
</head>
<body>

<div id="mainContent">
  <header><h3>تقرير حصة الانتظار</h3></header>
  <div id="waiting" class="tab-content active">
    <h3><label>حصة الانتظار</label></h3>

    <!-- اسم المعلمة الأساسية والمادة / معلمة الانتظار والتخصص -->
    <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px;">
      <div><label>المعلمة الأساسية</label><input type="text" /></div>
      <div><label>المادة</label><input type="text" /></div>
      <div><label>معلمة الانتظار</label><input type="text" /></div>
      <div><label>التخصص</label><input type="text" /></div>
    </div>

    <!-- الفصل الدراسي / اليوم / التاريخ -->
    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px;">
      <div><label>الفصل الدراسي</label><input type="text" /></div>
      <div><label>اليوم</label><input type="text" /></div>
      <div><label>التاريخ</label><input type="text" id="waitingDate" placeholder="اختر التاريخ" readonly /></div>
    </div>

    <!-- الصف / الحصة -->
    <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:5px;">
      <div><label>الصف</label><input type="text" /></div>
      <div><label>الحصة</label><input type="text" /></div>
    </div>

    <!-- البرامج المنفذة -->
    <label>البرامج المنفذة</label>
    <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:5px;">
      <input type="text" /><input type="text" />
      <input type="text" /><input type="text" />
    </div>

    <!-- الصور -->
    <label>الشواهد</label>
    <input type="file" multiple accept="image/*" onchange="storeImages(event,'waiting')" />
    <div id="waiting-counter" style="font-size:12px; color:#15445a; font-weight:bold;">عدد الصور المرفوعة: 0 / 4</div>
    <div id="waiting-preview" style="display:flex; gap:5px; flex-wrap:wrap; margin-top:5px;"></div>

    <!-- مديرة المدرسة -->
    <div id="directorField" style="display:flex; justify-content:center; margin-top:10px;">
      <div style="width:200px;">
        <label>مديرة المدرسة</label>
        <input type="text" id="directorName" />
      </div>
    </div>

    <!-- الأزرار -->
    <button class="printBtn" onclick="printPDF('waiting',this)">طباعة التقرير</button>
    <button class="deleteBtn" onclick="clearForm('waiting')">حذف البيانات</button>
  </div>
 </div>

<script>
let uploadedImages = {};

document.addEventListener("DOMContentLoaded", function() {
  const dateInput = document.getElementById('waitingDate');
  if (dateInput) {
    flatpickr(dateInput, {
      locale: 'ar',
      disableMobile: true,
      altInput: true,
      altFormat: 'd-MM-yyyy هـ',
      dateFormat: 'Y-m-d',
      onChange: function(selectedDates, dateStr, instance) {
        if (selectedDates.length > 0) {
          const miladi = selectedDates[0];
          miladi.setDate(miladi.getDate() - 1);
          const hijri = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).format(miladi);
          instance.altInput.value = hijri;
        }
      }
    });
  }

  loadForm('waiting');
  updateCounter('waiting');
  renderPreview('waiting');

  document.querySelectorAll('#waiting input[type="text"], #waiting textarea').forEach(input => {
    input.addEventListener('input', () => saveForm('waiting'));
  });
});

function saveForm(tabId) {
  const tab = document.getElementById(tabId);
  const data = {};
  tab.querySelectorAll('input[type="text"],textarea').forEach(input => {
    data[input.previousElementSibling ? input.previousElementSibling.textContent : input.name] = input.value;
  });
  localStorage.setItem(tabId + '-form', JSON.stringify(data));
}

function loadForm(tabId) {
  const tab = document.getElementById(tabId);
  const data = JSON.parse(localStorage.getItem(tabId + '-form') || '{}');
  tab.querySelectorAll('input[type="text"],textarea').forEach(input => {
    const key = input.previousElementSibling ? input.previousElementSibling.textContent : input.name;
    if (data[key]) input.value = data[key];
  });
}

function clearForm(tabId) {
  const tab = document.getElementById(tabId);
  tab.querySelectorAll('input[type="text"],textarea').forEach(input => input.value = '');
  uploadedImages[tabId] = [];
  updateCounter(tabId);
  renderPreview(tabId);
  localStorage.removeItem(tabId + '-form');
}

function storeImages(event, tabId) {
  const files = event.target.files;
  if (!uploadedImages[tabId]) uploadedImages[tabId] = [];
  if (uploadedImages[tabId].length + files.length > 4) {
    alert('مسموح برفع 4 صور فقط.');
    event.target.value = '';
    return;
  }
  for (let i = 0; i < files.length; i++) {
    const reader = new FileReader();
    reader.onload = function (e) {
      uploadedImages[tabId].push(e.target.result);
      updateCounter(tabId);
      renderPreview(tabId);
      saveForm(tabId);
    };
    reader.readAsDataURL(files[i]);
  }
}

function updateCounter(tabId) {
  const counter = document.getElementById(tabId + '-counter');
  if (counter) {
    const count = uploadedImages[tabId]?.length || 0;
    counter.textContent = 'عدد الصور المرفوعة: ' + count + ' / 4';
    counter.style.color = count >= 4 ? 'red' : '#15445a';
  }
}

function renderPreview(tabId) {
  const preview = document.getElementById(tabId + '-preview');
  preview.innerHTML = '';
  (uploadedImages[tabId] || []).forEach((src, index) => {
    const container = document.createElement('div');
    container.style.position = 'relative';
    const img = document.createElement('img');
    img.src = src;
    img.style.width = '70px';
    img.style.height = '70px';
    img.style.objectFit = 'cover';
    img.style.border = '1px solid #ccc';
    img.style.borderRadius = '4px';
    const btn = document.createElement('button');
    btn.textContent = 'x';
    btn.style.position = 'absolute';
    btn.style.top = '2px';
    btn.style.left = '50%';
    btn.style.transform = 'translateX(-50%)';
    btn.style.width = '18px';
    btn.style.height = '18px';
    btn.style.fontSize = '10px';
    btn.style.background = 'red';
    btn.style.color = 'white';
    btn.style.border = '2px solid white';
    btn.style.borderRadius = '50%';
    btn.style.cursor = 'pointer';
    btn.onclick = () => {
      uploadedImages[tabId].splice(index, 1);
      updateCounter(tabId);
      renderPreview(tabId);
      saveForm(tabId);
    };
    container.appendChild(img);
    container.appendChild(btn);
    preview.appendChild(container);
  });
}

function printPDF(tabId, btn) {
  const content = document.getElementById(tabId).cloneNode(true);
  content.querySelectorAll('button,input[type="file"],#' + tabId + '-counter,#' + tabId + '-preview,#directorField').forEach(el => el.remove());

  const wrapper = document.createElement('div');
  wrapper.style.position = 'relative';
  wrapper.style.width = '210mm';
  wrapper.style.height = '296.5mm';
  wrapper.style.padding = '50mm 10mm 20mm 10mm';
  wrapper.style.boxSizing = 'border-box';
  wrapper.style.backgroundImage = 'url("images/background.png")';
  wrapper.style.backgroundSize = 'cover';
  wrapper.style.backgroundRepeat = 'no-repeat';
  wrapper.style.backgroundPosition = 'center';
  wrapper.appendChild(content);

  const tabImages = uploadedImages[tabId] || [];
  if (tabImages.length > 0) {
    const imagesWrapper = document.createElement('div');
    imagesWrapper.style.display = 'flex';
    imagesWrapper.style.justifyContent = 'center';
    imagesWrapper.style.marginTop = '5px';
    imagesWrapper.style.gap = '5px';
    tabImages.forEach(src => {
      const img = document.createElement('img');
      img.src = src;
      img.style.width = '160px';
      img.style.height = '220px';
      img.style.objectFit = 'cover';
      imagesWrapper.appendChild(img);
    });
    wrapper.appendChild(imagesWrapper);
  }

  const originalDirector = document.getElementById('directorName');
  const directorDiv = document.createElement('div');
  directorDiv.style.marginTop = '10px';
  directorDiv.style.textAlign = 'center';

  const directorLabel = document.createElement('label');
  directorLabel.textContent = 'مديرة المدرسة';
  directorLabel.style.display = 'block';
  directorLabel.style.fontWeight = 'bold';
  directorLabel.style.marginBottom = '5px';

  const directorInput = document.createElement('input');
  directorInput.value = originalDirector?.value || '';
  directorInput.style.width = '200px';
  directorInput.style.margin = '0 auto';
  directorInput.style.textAlign = 'center';
  directorInput.style.border = '1px solid #c2c1c2';
  directorInput.style.borderRadius = '4px';
  directorInput.style.padding = '4px';
  directorInput.style.background = 'transparent';
  directorInput.readOnly = true;

  directorDiv.appendChild(directorLabel);
  directorDiv.appendChild(directorInput);
  wrapper.appendChild(directorDiv);

  html2pdf()
    .set({
      margin: 0,
      filename: 'waiting-report.pdf',
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { scale: 3, useCORS: true, backgroundColor: null, scrollY: 0 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    })
    .from(wrapper)
    .save();
}
</script>
</body>
</html>
