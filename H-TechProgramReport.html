<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>تقرير تنفيذ برنامج تقني</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
body {
    margin: 0;
    padding: 0;
    font-family: 'HelveticaNeueW23', Arial, sans-serif;
    background: #ffffff;
    font-size: 12px;
}
@font-face {
    font-family: 'HelveticaNeueW23';
    src: url('fonts/HelveticaNeueW23-Regular.ttf') format('truetype');
}
header {
    background: #005741;            /* لون الهوية الأساسي */
    color: white;
    text-align: center;
    padding: 10px;
    border-bottom: 3px solid #0aa2a9; /* تركوازي */
    font-size: 18px;
    font-weight: bold;
}
label {
    display: block;
    margin: 5px 0 2px;
    font-weight: bold;
    font-size: 12px;
    text-align: center;
    color: #333;
}
input, textarea {
    width: 100%;
    padding: 6px;
    border: 1px solid #c2c1c2;
    border-radius: 4px;
    margin-bottom: 5px;
    box-sizing: border-box;
    font-size: 12px;
    text-align: center;
    background: transparent;
    font-family: 'HelveticaNeueW23', Arial, sans-serif;
}
textarea { min-height: 40px; }
button {
    border: none;
    cursor: pointer;
    border-radius: 6px;
    width: 100%;
    font-family: 'HelveticaNeueW23', Arial, sans-serif;
}
button.printBtn { background: #555; color: white; padding: 8px 10px; font-size: 14px; font-weight: bold; }
button.deleteBtn { background: red; color: white; padding: 8px 10px; font-size: 14px; font-weight: bold; }

table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
    text-align: center;
    font-size: 12px;
}
th {
    background: #0aa2a9;    /* لون شريط العناوين */
    color: white;
    font-weight: bold;
    padding: 8px;
    border: 1px solid #ddd;
}
td {
    border: 1px solid #ddd;
    padding: 5px;
}

/* عرض الصور داخل الصفحة */
#waiting-preview {
    display:flex;
    flex-wrap:wrap;
    gap:5px;
    justify-content:center;
    margin-top:5px;
}
.preview-image-wrapper { position: relative; display: inline-block; }
.preview-image-wrapper img { width: 100px; height: 100px; object-fit: cover; border: 1px solid #ccc; border-radius: 4px; }
.remove-img-btn {
    position: absolute;
    top: -6px;
    left: -6px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: red;
    color: white;
    font-weight: bold;
    font-size: 14px;
    line-height: 18px;
    text-align: center;
    cursor: pointer;
}

footer { text-align: center; padding: 10px; color: black; font-weight: bold; font-size: 12px; }

@media print {
    body {
        background: none !important;
    }
    header, .deleteBtn, #waiting-counter { display: none !important; }
    input, textarea {
        background: transparent !important;
        color: black;
        border-color: #c2c1c2;
        font-size: 12px;
        text-align: center;
    }
    @page { margin: 45mm 10mm 10mm 10mm; }
}
</style>
</head>
<body>

<div id="mainContent">
    <header>تقرير تنفيذ برنامج تقني</header>

    <div id="waiting" class="tab-content active">
        <div style="display:flex; gap:10px; justify-content:center; margin-bottom:10px;">
            <div style="width:200px;"><label>إدارة التعليم</label><input type="text" id="eduDept" /></div>
            <div style="width:200px;"><label>اسم المدرسة</label><input type="text" id="schoolName" /></div>
        </div>

        <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:5px;">
            <div><label>اسم البرنامج</label><input type="text" /></div>
            <div><label>مجال البرنامج</label><input type="text" /></div>
        </div>

        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px;">
            <div><label>المستهدفون</label><input type="text" /></div>
            <div><label>العدد</label><input type="text" /></div>
            <div><label>تاريخ التنفيذ</label><input type="text" id="date1" placeholder="اختر التاريخ" readonly /></div>
            <div><label>مدة التنفيذ</label><input type="text" /></div>
        </div>

        <table>
            <tr><th>وصف البرنامج</th></tr>
            <tr><td><input type="text" placeholder="اكتب وصف البرنامج هنا" /></td></tr>
        </table>

        <table>
            <tr><th colspan="2">أهداف البرنامج</th></tr>
            <tr><td><input type="text" /></td><td><input type="text" /></td></tr>
            <tr><td><input type="text" /></td><td><input type="text" /></td></tr>
        </table>

        <table>
            <tr><th colspan="2">الأثر الإيجابي للبرنامج</th></tr>
            <tr><td><input type="text" /></td><td><input type="text" /></td></tr>
            <tr><td><input type="text" /></td><td><input type="text" /></td></tr>
        </table>

        <label>الشواهد</label>
        <input type="file" multiple accept="image/*" onchange="storeImages(event,'waiting')" />
        <div id="waiting-counter" style="font-size:12px; color:#15445a; font-weight:bold;">عدد الصور المرفوعة: 0 / 4</div>
        <div id="waiting-preview"></div>

        <!-- المعلم والمدير (يظهر في الصفحة فقط ولن يُكرر عند الطباعة) -->
        <div id="top-director" style="display:flex; gap:10px; justify-content:center; margin-bottom:5px;">
            <div style="width:200px;">
                <label>اسم المعلمة</label>
                <input type="text" id="healthGuide" />
            </div>
            <div style="width:200px;">
                <label>مديرة المدرسة</label>
                <input type="text" id="schoolDirector" />
            </div>
        </div>

        <button class="printBtn" onclick="printPDF('waiting')" style="width:100%; margin-bottom:10px;">طباعة التقرير</button>
        <button class="deleteBtn" onclick="clearForm('waiting')" style="width:100%;">حذف البيانات</button>
    </div>
</div>

<script>
let uploadedImages = {};

document.addEventListener("DOMContentLoaded", function() {
    flatpickr("#date1", {
        locale: "ar",
        disableMobile: true,
        altInput: true,
        altFormat: "d-MM-yyyy هـ",
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr, instance) {
            if (selectedDates.length > 0) {
                const miladi = selectedDates[0];
                miladi.setDate(miladi.getDate() - 1);
                const hijri = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                }).format(miladi);
                instance.altInput.value = hijri;
            }
        }
    });
});

function clearForm(tabId) {
    const tab = document.getElementById(tabId);
    tab.querySelectorAll('input[type="text"],textarea').forEach(i => i.value = '');
    uploadedImages[tabId] = [];
    updateCounter(tabId);
    renderPreview(tabId);
}

function storeImages(event, tabId) {
    const files = event.target.files;
    if (!uploadedImages[tabId]) uploadedImages[tabId] = [];
    if (uploadedImages[tabId].length + files.length > 4) {
        alert('مسموح برفع 4 صور فقط.');
        event.target.value = '';
        return;
    }
    for (let file of files) {
        const reader = new FileReader();
        reader.onload = e => {
            uploadedImages[tabId].push(e.target.result);
            updateCounter(tabId);
            renderPreview(tabId);
        };
        reader.readAsDataURL(file);
    }
}

function updateCounter(tabId) {
    const counter = document.getElementById(tabId + '-counter');
    if (counter) {
        const count = uploadedImages[tabId]?.length || 0;
        counter.textContent = 'عدد الصور المرفوعة: ' + count + ' / 4';
    }
}

function renderPreview(tabId) {
    const preview = document.getElementById(tabId + '-preview');
    preview.innerHTML = '';
    (uploadedImages[tabId] || []).forEach((src, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'preview-image-wrapper';
        const img = document.createElement('img');
        img.src = src;
        const btn = document.createElement('div');
        btn.className = 'remove-img-btn';
        btn.innerText = '×';
        btn.onclick = () => {
            uploadedImages[tabId].splice(index, 1);
            renderPreview(tabId);
            updateCounter(tabId);
        };
        wrapper.appendChild(img);
        wrapper.appendChild(btn);
        preview.appendChild(wrapper);
    });
}

function printPDF(tabId) {
    const content = document.getElementById(tabId).cloneNode(true);

    // إزالة العناصر غير المطلوبة للطباعة
    content.querySelectorAll('button,input[type="file"],#' + tabId + '-counter,#' + tabId + '-preview').forEach(el => el.remove());

    // إزالة قسم المعلم والمدير من النسخة الأصلية لتفادي التكرار
    const topDirector = content.querySelector('#top-director');
    if (topDirector) topDirector.remove();

    const wrapper = document.createElement('div');
    wrapper.style.position = 'relative';
    wrapper.style.width = '210mm';
    wrapper.style.height = '296.5mm';
    wrapper.style.padding = '50mm 10mm 10mm 10mm';
    wrapper.style.boxSizing = 'border-box';
    wrapper.style.backgroundImage = 'url("images/background.png")';
    wrapper.style.backgroundSize = 'cover';
    wrapper.style.backgroundRepeat = 'no-repeat';
    wrapper.style.backgroundPosition = 'center';
    wrapper.appendChild(content);

    // إضافة الصور أسفل التقرير
    const tabImages = uploadedImages[tabId] || [];
    if(tabImages.length > 0){
        const imagesWrapper = document.createElement('div');
        imagesWrapper.style.display='flex';
        imagesWrapper.style.flexWrap='wrap';
        imagesWrapper.style.justifyContent='center';
        imagesWrapper.style.marginTop='20px';
        imagesWrapper.style.gap='10px';
        tabImages.forEach(src=>{
            const img=document.createElement('img');
            img.src=src;
            img.style.width='165px';
            img.style.height='165px';
            img.style.objectFit='cover';
            img.style.border='1px solid #ccc';
            img.style.borderRadius='4px';
            imagesWrapper.appendChild(img);
        });
        wrapper.appendChild(imagesWrapper);

        // إضافة المعلمة والمديرة أسفل الصور فقط
        const directorClone = document.getElementById('top-director').cloneNode(true);
        directorClone.style.display = 'flex';
        directorClone.style.justifyContent = 'center';
        directorClone.style.marginTop = '10px';
        wrapper.appendChild(directorClone);
    }

    html2pdf().set({
        margin:0,
        filename:'تقرير_برنامج_تقني.pdf',
        image:{type:'jpeg',quality:0.95},
        html2canvas:{scale:3,useCORS:true,backgroundColor:null,scrollY:0},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
    }).from(wrapper).save();
}
</script>

</body>
</html>